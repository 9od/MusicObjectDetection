import os
import shutil
import unittest

import pandas as pd
from hamcrest import assert_that, is_, equal_to

from MusicObjectDetection.datasets.download_all_datasets import download_all_datasets
from MusicObjectDetection.preprocessing.normalize_all_datasets import normalize_all_datasets

deepscores_training_images = {'images/lg-100032803-aug-beethoven-.png',
                              'images/lg-100032803-aug-emmentaler-.png',
                              'images/lg-100032803-aug-gonville-.png',
                              'images/lg-100032803-aug-lilyjazz-.png',
                              'images/lg-100052827-aug-beethoven--page-2.png',
                              'images/lg-100052827-aug-beethoven--page-3.png',
                              'images/lg-100052827-aug-beethoven--page-4.png',
                              'images/lg-100052827-aug-beethoven--page-5.png',
                              'images/lg-100052827-aug-emmentaler--page-2.png',
                              'images/lg-100052827-aug-emmentaler--page-4.png',
                              'images/lg-100052827-aug-gonville--page-1.png',
                              'images/lg-100052827-aug-gonville--page-2.png',
                              'images/lg-100052827-aug-gonville--page-4.png',
                              'images/lg-100052827-aug-gonville--page-5.png',
                              'images/lg-100052827-aug-gutenberg1939--page-1.png',
                              'images/lg-100052827-aug-gutenberg1939--page-3.png',
                              'images/lg-100052827-aug-gutenberg1939--page-4.png',
                              'images/lg-100052827-aug-gutenberg1939--page-5.png',
                              'images/lg-100052827-aug-lilyjazz--page-1.png',
                              'images/lg-100052827-aug-lilyjazz--page-2.png',
                              'images/lg-100052827-aug-lilyjazz--page-4.png',
                              'images/lg-100052827-aug-lilyjazz--page-5.png',
                              'images/lg-100057130-aug-beethoven--page-10.png',
                              'images/lg-100057130-aug-beethoven--page-13.png',
                              'images/lg-100057130-aug-beethoven--page-14.png',
                              'images/lg-100057130-aug-beethoven--page-2.png',
                              'images/lg-100057130-aug-beethoven--page-4.png',
                              'images/lg-100057130-aug-beethoven--page-5.png',
                              'images/lg-100057130-aug-beethoven--page-7.png',
                              'images/lg-100057130-aug-beethoven--page-8.png',
                              'images/lg-100057130-aug-beethoven--page-9.png',
                              'images/lg-100057130-aug-emmentaler--page-10.png',
                              'images/lg-100057130-aug-emmentaler--page-11.png',
                              'images/lg-100057130-aug-emmentaler--page-2.png',
                              'images/lg-100057130-aug-emmentaler--page-5.png',
                              'images/lg-100057130-aug-emmentaler--page-6.png',
                              'images/lg-100057130-aug-emmentaler--page-8.png',
                              'images/lg-100057130-aug-emmentaler--page-9.png',
                              'images/lg-100057130-aug-gonville--page-1.png',
                              'images/lg-100057130-aug-gonville--page-12.png',
                              'images/lg-100057130-aug-gonville--page-15.png',
                              'images/lg-100057130-aug-gonville--page-3.png',
                              'images/lg-100057130-aug-gonville--page-4.png',
                              'images/lg-100057130-aug-gonville--page-5.png',
                              'images/lg-100057130-aug-gonville--page-8.png',
                              'images/lg-100057130-aug-gutenberg1939--page-10.png',
                              'images/lg-100057130-aug-gutenberg1939--page-14.png',
                              'images/lg-100057130-aug-gutenberg1939--page-15.png',
                              'images/lg-100057130-aug-gutenberg1939--page-2.png',
                              'images/lg-100057130-aug-gutenberg1939--page-3.png',
                              'images/lg-100057130-aug-gutenberg1939--page-4.png',
                              'images/lg-100057130-aug-gutenberg1939--page-5.png',
                              'images/lg-100057130-aug-gutenberg1939--page-7.png',
                              'images/lg-100057130-aug-gutenberg1939--page-8.png',
                              'images/lg-100057130-aug-lilyjazz--page-1.png',
                              'images/lg-100057130-aug-lilyjazz--page-10.png',
                              'images/lg-100057130-aug-lilyjazz--page-11.png',
                              'images/lg-100057130-aug-lilyjazz--page-13.png',
                              'images/lg-100057130-aug-lilyjazz--page-3.png',
                              'images/lg-100057130-aug-lilyjazz--page-4.png'}

deepscores_validation_images = {'images/lg-100052827-aug-beethoven--page-1.png',
                                'images/lg-100052827-aug-emmentaler--page-3.png',
                                'images/lg-100052827-aug-gonville--page-3.png',
                                'images/lg-100052827-aug-lilyjazz--page-3.png',
                                'images/lg-100057130-aug-beethoven--page-11.png',
                                'images/lg-100057130-aug-beethoven--page-12.png',
                                'images/lg-100057130-aug-beethoven--page-15.png',
                                'images/lg-100057130-aug-beethoven--page-3.png',
                                'images/lg-100057130-aug-emmentaler--page-1.png',
                                'images/lg-100057130-aug-emmentaler--page-13.png',
                                'images/lg-100057130-aug-emmentaler--page-15.png',
                                'images/lg-100057130-aug-emmentaler--page-3.png',
                                'images/lg-100057130-aug-gonville--page-10.png',
                                'images/lg-100057130-aug-gonville--page-11.png',
                                'images/lg-100057130-aug-gonville--page-13.png',
                                'images/lg-100057130-aug-gonville--page-14.png',
                                'images/lg-100057130-aug-gonville--page-9.png',
                                'images/lg-100057130-aug-gutenberg1939--page-13.png',
                                'images/lg-100057130-aug-lilyjazz--page-15.png',
                                'images/lg-100057130-aug-lilyjazz--page-2.png'}

deepscores_test_images = {'images/lg-100032803-aug-gutenberg1939-.png',
                          'images/lg-100052827-aug-emmentaler--page-1.png',
                          'images/lg-100052827-aug-emmentaler--page-5.png',
                          'images/lg-100052827-aug-gutenberg1939--page-2.png',
                          'images/lg-100057130-aug-beethoven--page-1.png',
                          'images/lg-100057130-aug-beethoven--page-6.png',
                          'images/lg-100057130-aug-emmentaler--page-12.png',
                          'images/lg-100057130-aug-emmentaler--page-14.png',
                          'images/lg-100057130-aug-emmentaler--page-4.png',
                          'images/lg-100057130-aug-emmentaler--page-7.png',
                          'images/lg-100057130-aug-gonville--page-2.png',
                          'images/lg-100057130-aug-gonville--page-6.png',
                          'images/lg-100057130-aug-gonville--page-7.png',
                          'images/lg-100057130-aug-gutenberg1939--page-1.png',
                          'images/lg-100057130-aug-gutenberg1939--page-11.png',
                          'images/lg-100057130-aug-gutenberg1939--page-12.png',
                          'images/lg-100057130-aug-gutenberg1939--page-6.png',
                          'images/lg-100057130-aug-gutenberg1939--page-9.png',
                          'images/lg-100057130-aug-lilyjazz--page-12.png',
                          'images/lg-100057130-aug-lilyjazz--page-14.png'}

mensural_training_images = {'images/00518.png',
                            'images/00519.png',
                            'images/00521.png',
                            'images/00523.png',
                            'images/00524.png',
                            'images/00525.png',
                            'images/00526.png',
                            'images/00529.png',
                            'images/00531.png',
                            'images/12608.png',
                            'images/12609.png',
                            'images/12611.png',
                            'images/12613.png',
                            'images/12616.png',
                            'images/12618.png',
                            'images/12630.png',
                            'images/12641.png',
                            'images/12643.png',
                            'images/12660.png',
                            'images/12665.png',
                            'images/12667.png',
                            'images/12668.png',
                            'images/12669.png',
                            'images/12672.png',
                            'images/12673.png',
                            'images/12680.png',
                            'images/12681.png',
                            'images/12682.png'}

mensural_validation_images = {'images/00520.png',
                              'images/12612.png',
                              'images/12617.png',
                              'images/12633.png',
                              'images/12634.png',
                              'images/12636.png',
                              'images/12644.png',
                              'images/12645.png',
                              'images/12649.png'}

mensural_test_images = {'images/00522.png',
                        'images/00527.png',
                        'images/12610.png',
                        'images/12624.png',
                        'images/12625.png',
                        'images/12642.png',
                        'images/12659.png',
                        'images/12675.png',
                        'images/12677.png'}

muscima_training_images = {'images/w-01_p019.png',
                           'images/w-02_p006.png',
                           'images/w-02_p013.png',
                           'images/w-02_p017.png',
                           'images/w-03_p001.png',
                           'images/w-03_p018.png',
                           'images/w-04_p020.png',
                           'images/w-06_p003.png',
                           'images/w-06_p016.png',
                           'images/w-08_p010.png',
                           'images/w-08_p014.png',
                           'images/w-08_p015.png',
                           'images/w-09_p006.png',
                           'images/w-09_p013.png',
                           'images/w-09_p017.png',
                           'images/w-10_p001.png',
                           'images/w-10_p007.png',
                           'images/w-10_p018.png',
                           'images/w-11_p009.png',
                           'images/w-11_p012.png',
                           'images/w-12_p004.png',
                           'images/w-12_p019.png',
                           'images/w-13_p002.png',
                           'images/w-13_p016.png',
                           'images/w-14_p005.png',
                           'images/w-14_p008.png',
                           'images/w-15_p015.png',
                           'images/w-16_p006.png',
                           'images/w-16_p013.png',
                           'images/w-16_p017.png',
                           'images/w-17_p001.png',
                           'images/w-17_p007.png',
                           'images/w-18_p009.png',
                           'images/w-18_p020.png',
                           'images/w-19_p004.png',
                           'images/w-19_p019.png',
                           'images/w-20_p002.png',
                           'images/w-20_p016.png',
                           'images/w-21_p005.png',
                           'images/w-21_p008.png',
                           'images/w-22_p014.png',
                           'images/w-22_p015.png',
                           'images/w-23_p006.png',
                           'images/w-24_p001.png',
                           'images/w-24_p018.png',
                           'images/w-25_p012.png',
                           'images/w-26_p019.png',
                           'images/w-27_p002.png',
                           'images/w-27_p003.png',
                           'images/w-27_p016.png',
                           'images/w-29_p010.png',
                           'images/w-29_p014.png',
                           'images/w-29_p015.png',
                           'images/w-30_p017.png',
                           'images/w-31_p001.png',
                           'images/w-31_p007.png',
                           'images/w-31_p018.png',
                           'images/w-32_p009.png',
                           'images/w-33_p004.png',
                           'images/w-34_p002.png',
                           'images/w-35_p011.png',
                           'images/w-36_p010.png',
                           'images/w-36_p014.png',
                           'images/w-37_p017.png',
                           'images/w-38_p018.png',
                           'images/w-39_p012.png',
                           'images/w-39_p020.png',
                           'images/w-40_p004.png',
                           'images/w-40_p019.png',
                           'images/w-41_p003.png',
                           'images/w-42_p008.png',
                           'images/w-42_p011.png',
                           'images/w-43_p014.png',
                           'images/w-43_p015.png',
                           'images/w-45_p001.png',
                           'images/w-45_p018.png',
                           'images/w-46_p007.png',
                           'images/w-46_p020.png',
                           'images/w-47_p004.png',
                           'images/w-48_p002.png',
                           'images/w-49_p009.png',
                           'images/w-50_p004.png',
                           'images/w-50_p008.png',
                           'images/w-50_p015.png'}

muscima_validation_images = {'images/w-04_p012.png',
                             'images/w-05_p011.png',
                             'images/w-07_p005.png',
                             'images/w-07_p008.png',
                             'images/w-12_p011.png',
                             'images/w-13_p003.png',
                             'images/w-15_p010.png',
                             'images/w-20_p003.png',
                             'images/w-24_p007.png',
                             'images/w-25_p009.png',
                             'images/w-26_p011.png',
                             'images/w-28_p005.png',
                             'images/w-28_p009.png',
                             'images/w-32_p012.png',
                             'images/w-32_p020.png',
                             'images/w-34_p016.png',
                             'images/w-35_p008.png',
                             'images/w-36_p015.png',
                             'images/w-37_p006.png',
                             'images/w-38_p007.png',
                             'images/w-41_p016.png',
                             'images/w-42_p005.png',
                             'images/w-44_p006.png',
                             'images/w-44_p017.png',
                             'images/w-47_p012.png',
                             'images/w-48_p016.png',
                             'images/w-49_p003.png',
                             'images/w-49_p005.png'}

muscima_test_images = {'images/w-01_p010.png',
                       'images/w-01_p014.png',
                       'images/w-03_p007.png',
                       'images/w-04_p009.png',
                       'images/w-05_p019.png',
                       'images/w-06_p002.png',
                       'images/w-11_p020.png',
                       'images/w-15_p014.png',
                       'images/w-17_p018.png',
                       'images/w-18_p012.png',
                       'images/w-19_p011.png',
                       'images/w-22_p010.png',
                       'images/w-23_p013.png',
                       'images/w-23_p017.png',
                       'images/w-25_p020.png',
                       'images/w-26_p004.png',
                       'images/w-28_p008.png',
                       'images/w-30_p006.png',
                       'images/w-30_p013.png',
                       'images/w-33_p019.png',
                       'images/w-34_p003.png',
                       'images/w-35_p005.png',
                       'images/w-37_p013.png',
                       'images/w-38_p001.png',
                       'images/w-41_p002.png',
                       'images/w-43_p010.png',
                       'images/w-44_p013.png',
                       'images/w-49_p011.png'}


def compare_dataset_splits(path_to_dataset, training_set, validation_set,
                           test_set):
    training_annotations = set(pd.read_csv(os.path.join(path_to_dataset, "training.csv"))["path_to_image"].unique())
    validation_annotations = set(pd.read_csv(os.path.join(path_to_dataset, "validation.csv"))["path_to_image"].unique())
    test_annotations = set(pd.read_csv(os.path.join(path_to_dataset, "test.csv"))["path_to_image"].unique())
    assert_that(training_annotations, is_(equal_to(training_set)))
    assert_that(validation_annotations, is_(equal_to(validation_set)))
    assert_that(test_annotations, is_(equal_to(test_set)))


class DatasetSplitterTest(unittest.TestCase):
    def test_download_and_normalize_datasets_assert_correct_test_splits(self):
        download_all_datasets("temp")
        normalize_all_datasets("temp")

        path_to_deepscores = "temp/normalized/deepscores"
        path_to_mensural = "temp/normalized/mensural"
        path_to_muscima = "temp/normalized/muscima"

        compare_dataset_splits(path_to_deepscores, deepscores_training_images, deepscores_validation_images,
                               deepscores_test_images)
        compare_dataset_splits(path_to_mensural, mensural_training_images, mensural_validation_images,
                               mensural_test_images)
        compare_dataset_splits(path_to_muscima, muscima_training_images, muscima_validation_images,
                               muscima_test_images)

        shutil.rmtree("temp", ignore_errors=True)


if __name__ == '__main__':
    unittest.main()
